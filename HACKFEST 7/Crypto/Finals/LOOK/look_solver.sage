#!/usr/bin/env sage

"""

Author : msalaani
Task : Look - Solver
Event : Hackfest 7 - Finals

"""
from Crypto.Util.number import *

def CoppersmithShortPadAttack(e,n,C1,C2,pbits, eps=1/25):
	P.<x, y> = PolynomialRing(Zmod(n))
	P2.<y> = PolynomialRing(Zmod(n))

	g1 = (Vi(e, x) - C1).change_ring(P2)
	g2 = (Vi(e, x + y) - C2).change_ring(P2)

	res = g1.resultant(g2, variable=x)

	roots = res.univariate_polynomial().change_ring(Zmod(n)).small_roots(X = 2**pbits, epsilon=eps)
	if len(roots) == 1:
		return int(roots[0])

def FranklinReiterRelatedMessages(C1, C2, N, r, e = 3):
    P.<x> = PolynomialRing(Zmod(N))
    equations = [Vi(e, x) - C1, Vi(e, x+r) - C2]
    g1, g2 = equations
    return int(-composite_gcd(g1, g2).coefficients()[0])

def composite_gcd(g1, g2):
    return g1.monic() if g2 == 0 else composite_gcd(g2, g1 % g2)


def Vi(n, P, N = 1, Q = 1):
	if n == 0:
		return 2
	if n == 1:
		return P
	return (P*Vi(n-1, P, N, Q) - Q*Vi(n-2, P, N, Q))

N = 139660928066306041190911255089657582322026916219817003925853675886658342887850152668752823837070132837972500627214382143759117327008827265412675952727746883124678669857216850083060654667389570840882373986063346595495519746667420703863779656943191065087444757438383690176674151388797091126088869184624328713891
e = 3
C1 = 7716708646526522410471072042125617057022881467794853321110639152515592856797066989257371659360826879287797590860754878446282931547209457728229755466946379141593677456865466689555908355287519250833997420155478916525628959249476105898858377077705424810134553811506559667642877044101803030859961051331733728552
C2 = 57601329165087944936257582219449732986661463160853015318583381834887767231734978305263082689971591941398842334586993412616019709698488743527800679986869465725120565923385315598175081982476760294330392471431048911455345248730594417489220713269852059655034177061204343340147823363437650089286103040756254141761

diff = CoppersmithShortPadAttack(e,N,C1,C2,72)
FLAG = FranklinReiterRelatedMessages(C1, C2, N, diff) >> 72

assert long_to_bytes(FLAG) == b"HACKFEST{425D0544e3813ef357C662e0398A537b9d72a2dbb51D03B9B7B759400decF000}" 